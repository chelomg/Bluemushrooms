<html lang="zh-TW">
  <style>
    @font-face {
    font-family: 'wakan';
    src: url('fonts/TpldKhangXiDictTrial.otf') format('truetype');
    unicode-range: U+5927, U+5BB6, U+5FEB, U+4F86, U+627E, U+FF0C, U+4E00, U+6A23, U+7684, U+7259, U+5957, U+54E5, U+54E5, U+5728, U+54EA, U+88E1, U+5DF2, U+627E, U+5230, U+FF1A, U+7D44, U+8CBC, U+5716, U+66F4, U+591A, U+5169, U+500B,U+56C9, U+FF01 ;
    }
    p {font-family: 'wakan',serif;}
  </style>
  <head>
  <title>測測你的記憶力（藍瘦香菇篇）</title>
  <meta charset="utf-8">
  <!-- cover by http://www.108js.com/article/article3/30001.html?id=5-->
  <script type="text/javascript">
    window.onload = function () {
      var ctx = document.getElementById('canvas').getContext('2d'); 
        if (window.innerHeight > window.innerWidth){ //手機螢幕
            ctx.canvas.width  = window.innerWidth;
            ctx.canvas.height = window.innerWidth+100; 

        }else{ //電腦螢幕
            ctx.canvas.width  = window.innerHeight-150;
            ctx.canvas.height = window.innerHeight-150;          

        }      
        init();
    }
  </script>
  <script type="text/javascript">
    function $(id){
      return document.getElementById(id);
    }
    var pixwidth;
    wh = window.innerHeight
    ww = window.innerWidth
    if (wh > ww){ //手機螢幕
      pixwidth  = Math.floor((ww-50)/4)+1;
    }else{ //電腦螢幕
      pixwidth  = Math.floor((wh-300)/4)+1;
      console.log(pixwidth);
    }
    console.log((window.innerHeight-300)/4);
    var backimg= new Image();
  	    backimg.src = "frontcover.jpg";	//撲克牌的背面圖片
    var backgimg= new Image();
        backgimg.src = "background.jpg"; //白圖用來蓋掉某些不需要的資訊 
    var finialx= new Image(); //gmae over 呈現的圖片
        finialx.src = "34.png"; 
    var endground= new Image(); //gmae over 呈現的圖片
        endground.src = "pink_rice.png"; 
    var backgroundimg = new Image();
        backgroundimg.src = "backgroundcolor.jpg";

  	var cwidth = 760;//canvas的宽和高
  	var cheight = 280;
  	var ctx;
  	var firstpick = true;
  	var firstcard = -1;
  	var secondcard=-1;
         var sum=0;//紀錄點擊牌的次数
      
  	var tablecolor = "rgb(255,255,255)";//用這個色清除圖片的背面
  	var deck = [];//一副牌，空數组
  	var firstsx = 0;//第一張牌的X坐標
  	var firstsy = 50;//第一張牌的Y坐標
  	var margin = 10;//牌之間的距離
  	var cardwidth = pixwidth;//牌的宽
  	var cardheight = pixwidth;//牌的高
  	var tid;//計時器引用
  	var matched;//兩張牌是否匹配
  	var starttime;
  	var count = 0;
  	var pairs = [//二维圖片数组

          ["01.png","01-1.png","05.png","05-1.png"],
          ["02.png","02-1.png","06.png","06-1.png"],
          ["03.png","03-1.png","07.png","07-1.png"],
          ["04.png","04-1.png","08.png","08-1.png"],
  	];
      var uiIntro ;//遊戲的玩法
      var uiStats;//遊戲的狀態
      var uiComplete;//遊戲结束的信息
      var uiReset;
      var uiScore;
      var uiScore1 
    function Card(sx,sy,swidth,sheight, img, info) {//牌類的構造函数
  	 this.sx = sx;
  	 this.sy = sy;
  	 this.swidth = swidth;
  	 this.sheight = sheight;
  	 this.info = info;//牌面信息，用於指示是否配對
  	 this.img = img;
  	 this.draw = drawback;//繪製自己,畫面的背面
    }
    function makedeck() {//創建一副牌
    	var i;
    	var acard;//a牌
    	var bcard;//與a配對的b牌
    	var pica;//a圖片
    	var picb;//與a配對的b圖片
    	var cx = firstsx;
    	var cy = firstsy;
    	for(i=0;i< pairs.length;i++) {
         pica = new Image();
         pica.src = pairs[i][0];
         acard = new Card(cx,cy,cardwidth,cardheight,pica,i*2);
         deck.push(acard);
         picb = new Image();
         picb.src = pairs[i][1];		
         bcard = new Card(cx,cy+cardheight+margin,cardwidth,cardheight,picb,i*2);//處於a的下方
         deck.push(bcard);
         acard.draw();
         bcard.draw();
         //
         pica = new Image();
         pica.src = pairs[i][2];
         acard = new Card(cx,cy+(cardheight+margin)*2,cardwidth,cardheight,pica,i*2+1);
         deck.push(acard);
         picb = new Image();
         picb.src = pairs[i][3];    
         bcard = new Card(cx,cy+(cardheight+margin)*3,cardwidth,cardheight,picb,i*2+1);//處於a的下方
         deck.push(bcard);
         acard.draw();
         bcard.draw();
         cx = cx+cardwidth+ margin;
      }
    	
    }
    function shuffle() {//洗牌
       var i;
       var k;
       var holderinfo;
       var holderimg;
       var dl = deck.length
       var nt;
       for (nt=0;nt< 3*dl;nt++) {  
         i = Math.floor(Math.random()*dl);
         k = Math.floor(Math.random()*dl);
         holderinfo = deck[i].info;//牌面的信息
         holderimg = deck[i].img;//牌面的圖片
         deck[i].info = deck[k].info;
         deck[i].img = deck[k].img;
         deck[k].info = holderinfo;
         deck[k].img = holderimg;
    	}
    }
    function drawback() {//畫牌的背面
          ctx.drawImage(backimg,this.sx,this.sy,this.swidth,this.sheight); 
    }
    function choose(ev) {//在桌面上單擊時用
    	var out;
    	var mx;//保存鼠標的X坐標
    	var my;//保存鼠標的Y坐標
    	var pick1;
    	var pick2;
    	if ( ev.layerX ||  ev.layerX == 0) { // Firefox
            mx= ev.layerX;
            my = ev.layerY;
      	} else if (ev.offsetX || ev.offsetX == 0) { // Opera
            mx = ev.offsetX;
            my = ev.offsetY;
      	}
    	var i;
    	for (i=0;i< deck.length;i++){    
         var card = deck[i];
         if (card.sx >=0)  //檢查鼠標是不是點了這張牌
          if ((mx>card.sx)&&(mx< card.sx+card.swidth)&&(my>card.sy)&&(my< card.sy+card.sheight)) {
              if(i==firstcard) return;
              sum++;   
              if(sum>=3) return;//點擊了同一張牌或者在没有蓋住兩張翻開的牌時又點擊了某張牌    
              if ((firstpick)|| (i!=firstcard)) {//玩家有没有再次點擊同一張牌
    			break;}
          }
    	}
    	if (i< deck.length) {  //在i張牌上點擊了
            if (firstpick) {//如果是第一次點擊
              firstcard = i;//第一次點擊的牌為i
              firstpick = false;
              ctx.drawImage(backgimg,card.sx,card.sy,card.swidth,card.sheight);
              ctx.drawImage(card.img,card.sx,card.sy,card.swidth,card.sheight); //翻開牌
    	      }else {
                secondcard = i;//第二次點擊的牌為i
                ctx.drawImage(backgimg,card.sx,card.sy,card.swidth,card.sheight);
                ctx.drawImage(card.img,card.sx,card.sy,card.swidth,card.sheight); //翻開第二張
                        if (card.info==deck[firstcard].info) {//翻開的二張牌如果配對
                                  matched = true;
                                  count++;
                                  uiScore.innerHTML=String(count);
                                  if (count>= .5*deck.length) {//所有的牌翻完了
                                          var now = new Date();
                                          var nt = Number(now.getTime());
                                          var seconds = Math.floor(.5+(nt-starttime)/1000);
                                          //記錄分數用
                                          if(localStorage.getItem("bluemushroom_score") == null||localStorage.getItem("bluemushroom_score") > seconds){
                                            localStorage.setItem("bluemushroom_score", seconds);
                                          }
                                          //最後結果顯示
                                          gameoverset(seconds);
                                          uiIntro.innerHTML = "<p>更多牙套哥貼圖 <a href='https://store.line.me/stickershop/product/1361178/?ref=Desktop';'>here</a></p>";
                                          //結束後，背景圖會變，所以字的風格也要修改
                                          document.getElementById("showscore").style.color = "black";
                                          document.getElementById("reButton").style.color = "black";
                                          document.getElementById("gameScore").style.color = "black";
                        					        //uiReset.innerHTML="請重新裝載頁面再玩.";
                                          //uiComplete.style.display="";
                                          return;
                                  }
                        }else {//翻開的二張牌不配對
                          matched = false;
                        }
                firstpick = true;
                tid = setTimeout(flipback,500);//翻開的二張牌不配對时，给玩家一點時間，然後蓋住牌
            }
      }
    }
    function flipback() {
    	var card;
    	if (!matched) {//兩張牌不配對时，重繪這兩張牌的背面
            //因為png檔，邊邊透明會看上一個畫的圖（牌的正面），所以我們必須先畫一層底圖來防止這件事
            ctx.drawImage(backgroundimg,deck[firstcard].sx,deck[firstcard].sy,deck[firstcard].swidth,deck[firstcard].sheight)
            ctx.drawImage(backgroundimg,deck[secondcard].sx,deck[secondcard].sy,deck[secondcard].swidth,deck[secondcard].sheight)
          	deck[firstcard].draw();
          	deck[secondcard].draw();
            sum=0;
            firstcard=-1;
      }
      else {
            //两張牌配對时，在桌面上清除

            //註解這三行是因為排翻完我不要讓他從檯面上消失
            //ctx.fillStyle = tablecolor;
            //ctx.fillRect(deck[secondcard].sx,deck[secondcard].sy,deck[secondcard].swidth,deck[secondcard].sheight+5);
            //ctx.fillRect(deck[firstcard].sx,deck[firstcard].sy,deck[firstcard].swidth,deck[firstcard].sheight+5);
            
            deck[secondcard].sx = -1;
            deck[firstcard].sx = -1;
            sum=0;
            firstcard=-1;
      }
    }
    function init(){
       ctx = document.getElementById('canvas').getContext('2d'); 
       canvas1 = document.getElementById('canvas');
       canvas1.addEventListener('click',choose,false);
       makedeck();//創建一副牌
       shuffle();//洗牌
       document.body.style.backgroundImage = "url('backgroundcolor.jpg')";  //我的底圖（背景圖）
       ctx.strokeStyle="rgb(255,0,0)";
       ctx.font="bold 20pt sans-serif";
       //ctx.strokeText("Blue thin mushrooms",150,30); 加標題
       starttime = new Date();
       starttime = Number(starttime.getTime());
    	 uiIntro = $("gameIntro");
    	 uiStats = $("gameStats");
    	 uiComplete = $("gameComplete");
    	 uiReset = $("gameReset");
    	 uiScore = $("gameScore");
    	 uiScore1 = $("gameScore1");
           uiComplete.style.display="none";
    } 
    function gameoverset(seconds){
      if (window.innerHeight > window.innerWidth){ //手機螢幕
        ctx.canvas.width  = window.innerWidth;
        ctx.canvas.height = window.innerWidth+100;
        document.body.style.backgroundImage = "url('pink_rice.png')";
        ctx.drawImage(endground,0,0,document.getElementById('canvas').width,document.getElementById('canvas').height);//結束把上面牌全部清空
        ctx.drawImage(finialx,document.getElementById('canvas').width*1/2-document.getElementById('canvas').height*3/10,document.getElementById('canvas').width*1/2-document.getElementById('canvas').height*2/5,document.getElementById('canvas').height*3/5,document.getElementById('canvas').height*3/5);
        ctx.font = "90px Arial";
        ctx.fillText("遊戲結束！",document.getElementById('canvas').width*1/2-225,document.getElementById('canvas').height*3/4);     
        ctx.fillText("時間 "+String(seconds)+" 秒",document.getElementById('canvas').width*1/2-225,document.getElementById('canvas').height*3/4+100);
        ctx.fillText("最佳 "+String(localStorage.getItem("bluemushroom_score"))+" 秒",document.getElementById('canvas').width*1/2-225,document.getElementById('canvas').height*3/4+200); 
      
      }else{ //電腦螢幕
        ctx.canvas.width  = window.innerHeight-150;
        ctx.canvas.height = window.innerHeight-150;
        document.body.style.backgroundImage = "url('pink_rice.png')";
        ctx.drawImage(endground,0,0,document.getElementById('canvas').width,document.getElementById('canvas').height);//結束把上面牌全部清空          
        ctx.drawImage(finialx,document.getElementById('canvas').width*2/7+70-document.getElementById('canvas').height*3/5/2,document.getElementById('canvas').width*1/2-document.getElementById('canvas').height*2/5,document.getElementById('canvas').height*3/5,document.getElementById('canvas').height*3/5);
        ctx.font = "35px Arial";
        ctx.fillText("遊戲結束！",document.getElementById('canvas').width*2/7,document.getElementById('canvas').height*4/5); 
        ctx.fillText("時間 "+String(seconds)+" 秒",document.getElementById('canvas').width*2/7,document.getElementById('canvas').height*4/5+40);
        ctx.fillText("時間 "+String(localStorage.getItem("bluemushroom_score"))+" 秒",document.getElementById('canvas').width*2/7,document.getElementById('canvas').height*4/5+80);
      } 

    }
  </script>
  <style type="text/css">
    #game{
      position:relative;
    }
    a{
      font-family: Microsoft JhengHei;
    }

  </style>
 </head>
<body >
  <canvas id="canvas" width="760" height="280">
    你的浏览器不支持HTML5
   </canvas>

  <br/>
  <div id="game"  >
    <div id="gameUI">
      <div id="gameIntro">
        <p style="color: black;" class = "wakan">大家快來找，一樣的牙套哥哥在哪裡</p>
      </div>

      <div id="gameStats">
        <p id="showscore" style="color: black;" class = "wakan">已經找到 
          <span id="gameScore" style="color:black; font-family: Microsoft JhengHei;" class = "wakan">0</span> 組一樣的牙套哥哥囉！
          <button id="reButton" onclick="myFunction()" style="color: black; border: 2px solid black; font-family: Microsoft JhengHei;">Reload page</button>
        </p>
      </div>
      

      <script>
      function myFunction() {
          location.reload();
      }
      </script> 

      <div id="gameComplete">
        <h1>遊戲結束!</h1>
        <p><span id="gameScore1" ></span> </p>
        <p><a id="gameReset" onclick="init();" href="" style="font-size: large">再玩一次</a></p>
      </div> 

      <script type="text/javascript">
      wh = window.innerHeight
      ww = window.innerWidth
      if (wh > ww){ //手機螢幕
        pixwidth  = Math.floor((ww-50)/4)+1;
        document.getElementById("gameScore1").style.fontSize = "60px";
        document.getElementById("gameIntro").style.fontSize = "60px";
        document.getElementById("gameStats").style.fontSize = "60px";
        document.getElementById("reButton").style.fontSize = "60px";
      }else{ //電腦螢幕
        pixwidth  = Math.floor((wh-300)/4)+1;
        document.getElementById("gameScore1").style.fontSize = "25px" ;
        document.getElementById("gameIntro").style.fontSize = "25px";
        document.getElementById("gameStats").style.fontSize = "25px";
        document.getElementById("reButton").style.fontSize = "25px";
      }
      </script>

    </div>
  </div>

</body></html>